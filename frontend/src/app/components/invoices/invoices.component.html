<div class="page-content fade-in">
  <div class="page-header">
    <h1>
      <mat-icon class="header-icon">receipt</mat-icon>
      Rechnungen
    </h1>
    <p class="text-secondary">Rechnungen anzeigen und verwalten</p>
  </div>

  <div *ngIf="isLoading" class="loading-spinner">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <div *ngIf="!isLoading" class="content-section">
    <!-- Filter Bar -->
    <div class="toolbar">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Rechnungen suchen</mat-label>
        <input matInput [(ngModel)]="searchTerm" (keyup)="applyFilter()" placeholder="Rechnungsnr. oder Kunde...">
        <mat-icon matPrefix>search</mat-icon>
      </mat-form-field>
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Status</mat-label>
        <mat-select [(ngModel)]="statusFilter" (selectionChange)="applyFilter()">
          <mat-option value="">Alle</mat-option>
          <mat-option *ngFor="let status of invoiceStatuses" [value]="status">{{ status }}</mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Action Bar -->
    <div class="action-bar" *ngIf="items.length > 0">
      <div class="selection-info">
        <span *ngIf="selection.selected.length > 0">
          {{ selection.selected.length }} von {{ items.length }} ausgewählt
        </span>
      </div>
      <div class="action-buttons">
        <!-- Separate PDFs -->
        <button mat-raised-button
                (click)="downloadSelected()"
                [disabled]="selection.selected.length === 0 || isDownloading"
                matTooltip="Ausgewählte als einzelne PDFs herunterladen">
          <mat-icon>download</mat-icon>
          <span *ngIf="!isDownloading">Einzeln ({{ selection.selected.length }})</span>
          <span *ngIf="isDownloading">Wird heruntergeladen...</span>
        </button>
        <button mat-raised-button
                (click)="downloadAll()"
                [disabled]="items.length === 0 || isDownloading"
                matTooltip="Alle als einzelne PDFs herunterladen">
          <mat-icon>download_for_offline</mat-icon>
          Alle einzeln
        </button>

        <!-- Combined PDFs -->
        <button mat-raised-button color="primary"
                (click)="downloadSelectedCombined()"
                [disabled]="selection.selected.length === 0 || isDownloading"
                matTooltip="Ausgewählte als ein Sammeldokument herunterladen">
          <mat-icon>picture_as_pdf</mat-icon>
          <span>Sammel-PDF ({{ selection.selected.length }})</span>
        </button>
        <button mat-raised-button color="accent"
                (click)="downloadAllCombined()"
                [disabled]="items.length === 0 || isDownloading"
                matTooltip="Alle Rechnungen als ein Sammeldokument herunterladen">
          <mat-icon>collections_bookmark</mat-icon>
          Alle als Sammel-PDF
        </button>
      </div>
    </div>

    <div class="table-container">
      <table mat-table [dataSource]="dataSource" matSort multiTemplateDataRows class="mat-elevation-z2">
        <!-- Checkbox Column -->
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef>
            <mat-checkbox (change)="$event ? toggleAllRows() : null"
                          [checked]="selection.hasValue() && isAllSelected()"
                          [indeterminate]="selection.hasValue() && !isAllSelected()">
            </mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let row">
            <mat-checkbox (click)="$event.stopPropagation()"
                          (change)="$event ? selection.toggle(row) : null"
                          [checked]="selection.isSelected(row)">
            </mat-checkbox>
          </td>
        </ng-container>

        <ng-container matColumnDef="invoiceNumber">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Rechnungsnr.</th>
          <td mat-cell *matCellDef="let item">
            <span class="invoice-number">{{ item.invoiceNumber }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="customerName">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Kunde</th>
          <td mat-cell *matCellDef="let item">{{ item.order.customerName }}</td>
        </ng-container>

        <ng-container matColumnDef="issueDate">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Ausstellungsdatum</th>
          <td mat-cell *matCellDef="let item">{{ item.issueDate | date:'mediumDate' }}</td>
        </ng-container>

        <ng-container matColumnDef="grandTotal">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Gesamtbetrag</th>
          <td mat-cell *matCellDef="let item">
            <span class="total-amount">€ {{ item.grandTotal | number:'1.2-2' }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="createdBy">
          <th mat-header-cell *matHeaderCellDef>Erstellt von</th>
          <td mat-cell *matCellDef="let item">{{ item.createdBy || '-' }}</td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
          <td mat-cell *matCellDef="let item">
            <mat-chip [color]="getStatusColor(item.status)">{{ item.status }}</mat-chip>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Aktionen</th>
          <td mat-cell *matCellDef="let item">
            <button mat-icon-button (click)="toggleExpand(item)" matTooltip="Details anzeigen">
              <mat-icon>{{ expandedElement === item ? 'expand_less' : 'expand_more' }}</mat-icon>
            </button>
            <button mat-icon-button color="primary" (click)="downloadPdf(item)" matTooltip="PDF herunterladen">
              <mat-icon>download</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="delete(item.id!)" matTooltip="Löschen">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <!-- Expanded Content Column -->
        <ng-container matColumnDef="expandedDetail">
          <td mat-cell *matCellDef="let item" [attr.colspan]="displayedColumns.length">
            <div class="invoice-detail" [@detailExpand]="item == expandedElement ? 'expanded' : 'collapsed'">
              <div class="detail-container">
                <div class="detail-section">
                  <h3><mat-icon>info</mat-icon> Rechnungsinformationen</h3>
                  <div class="detail-grid">
                    <div class="detail-item">
                      <span class="label">Rechnungsnummer:</span>
                      <span class="value">{{ item.invoiceNumber }}</span>
                    </div>
                    <div class="detail-item">
                      <span class="label">Bestellnummer:</span>
                      <span class="value">{{ item.order.id }}</span>
                    </div>
                    <div class="detail-item">
                      <span class="label">Ausstellungsdatum:</span>
                      <span class="value">{{ item.issueDate | date:'dd.MM.yyyy' }}</span>
                    </div>
                    <div class="detail-item">
                      <span class="label">Fälligkeitsdatum:</span>
                      <span class="value">{{ item.dueDate ? (item.dueDate | date:'dd.MM.yyyy') : 'Nicht festgelegt' }}</span>
                    </div>
                    <div class="detail-item">
                      <span class="label">Status:</span>
                      <span class="value"><mat-chip [color]="getStatusColor(item.status)">{{ item.status }}</mat-chip></span>
                    </div>
                    <div class="detail-item" *ngIf="item.createdBy">
                      <span class="label">Erstellt von:</span>
                      <span class="value">{{ item.createdBy }}</span>
                    </div>
                  </div>
                </div>

                <div class="detail-section">
                  <h3><mat-icon>person</mat-icon> Kundeninformationen</h3>
                  <div class="detail-grid">
                    <div class="detail-item">
                      <span class="label">Name:</span>
                      <span class="value">{{ item.order.customerName }}</span>
                    </div>
                    <div class="detail-item" *ngIf="item.order.customerPhone">
                      <span class="label">Telefon:</span>
                      <span class="value">{{ item.order.customerPhone }}</span>
                    </div>
                    <div class="detail-item" *ngIf="item.order.customerAddress">
                      <span class="label">Adresse:</span>
                      <span class="value">{{ item.order.customerAddress }}</span>
                    </div>
                  </div>
                </div>

                <div class="detail-section" *ngIf="item.order.items && item.order.items.length > 0">
                  <h3><mat-icon>shopping_cart</mat-icon> Bestellpositionen</h3>
                  <table class="items-table">
                    <thead>
                      <tr>
                        <th>Produkt</th>
                        <th>Gewicht (g)</th>
                        <th>Preis/kg</th>
                        <th>Zwischensumme</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let orderItem of item.order.items">
                        <td>{{ orderItem.itemName }}</td>
                        <td>
                          <span *ngIf="orderItem.weight">{{ (orderItem.weight * 1000) | number:'1.0-0' }} g</span>
                          <span *ngIf="!orderItem.weight">{{ orderItem.quantity }} g</span>
                        </td>
                        <td>€ {{ orderItem.unitPrice | number:'1.2-2' }}/kg</td>
                        <td>€ {{ orderItem.subtotal | number:'1.2-2' }}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div class="detail-section">
                  <h3><mat-icon>euro</mat-icon> Finanzen</h3>
                  <div class="finance-grid">
                    <div class="finance-row">
                      <span class="label">Nettobetrag:</span>
                      <span class="value">€ {{ item.totalAmount | number:'1.2-2' }}</span>
                    </div>
                    <div class="finance-row">
                      <span class="label">MwSt ({{ item.taxRate }}%):</span>
                      <span class="value">€ {{ item.taxAmount | number:'1.2-2' }}</span>
                    </div>
                    <div class="finance-row total">
                      <span class="label">Gesamtbetrag:</span>
                      <span class="value">€ {{ item.grandTotal | number:'1.2-2' }}</span>
                    </div>
                  </div>
                </div>

                <div class="detail-section" *ngIf="item.notes">
                  <h3><mat-icon>note</mat-icon> Anmerkungen</h3>
                  <p class="notes">{{ item.notes }}</p>
                </div>
              </div>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"
            class="invoice-row"
            [class.expanded-row]="expandedElement === row"></tr>
        <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>

        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell no-data" [attr.colspan]="displayedColumns.length">
            <div class="no-data-message">
              <mat-icon>receipt_long</mat-icon>
              <p>Keine Rechnungen gefunden</p>
            </div>
          </td>
        </tr>
      </table>
    </div>
  </div>
</div>
