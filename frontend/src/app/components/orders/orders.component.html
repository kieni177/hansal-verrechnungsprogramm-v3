<div class="page-content fade-in">
  <div class="page-header">
    <h1>
      <mat-icon class="header-icon">shopping_cart</mat-icon>
      Bestellungen
    </h1>
    <p class="text-secondary">Kundenbestellungen anzeigen und verwalten</p>
  </div>

  <div *ngIf="isLoading" class="loading-spinner">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <div *ngIf="!isLoading" class="content-section">
    <div class="toolbar">
      <button mat-raised-button color="primary" (click)="add()" class="add-button">
        <mat-icon>add</mat-icon>
        Bestellung erstellen
      </button>
    </div>

    <div class="table-container">
      <table mat-table [dataSource]="items" multiTemplateDataRows class="mat-elevation-z2">
        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef>Bestellung-Nr.</th>
          <td mat-cell *matCellDef="let item">
            <span class="order-number">{{ item.id }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="customerName">
          <th mat-header-cell *matHeaderCellDef>Kunde</th>
          <td mat-cell *matCellDef="let item">{{ item.customerName }}</td>
        </ng-container>

        <ng-container matColumnDef="orderDate">
          <th mat-header-cell *matHeaderCellDef>Bestelldatum</th>
          <td mat-cell *matCellDef="let item">{{ item.orderDate | date:'mediumDate' }}</td>
        </ng-container>

        <ng-container matColumnDef="totalAmount">
          <th mat-header-cell *matHeaderCellDef>Gesamtbetrag</th>
          <td mat-cell *matCellDef="let item">
            <span class="total-amount">€ {{ item.totalAmount | number:'1.2-2' }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let item">
            <mat-chip [color]="getStatusColor(item.status)">{{ item.status }}</mat-chip>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Aktionen</th>
          <td mat-cell *matCellDef="let item" (click)="$event.stopPropagation()">
            <button mat-icon-button (click)="toggleExpand(item)" matTooltip="Details anzeigen">
              <mat-icon>{{ expandedElement === item ? 'expand_less' : 'expand_more' }}</mat-icon>
            </button>
            <button mat-icon-button (click)="createInvoice(item)" matTooltip="Rechnung erstellen" color="primary">
              <mat-icon>receipt</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="delete(item.id!)" matTooltip="Löschen">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <!-- Expanded Content Column -->
        <ng-container matColumnDef="expandedDetail">
          <td mat-cell *matCellDef="let item" [attr.colspan]="displayedColumns.length">
            <div class="order-detail" [@detailExpand]="item == expandedElement ? 'expanded' : 'collapsed'">
              <div class="detail-container">
                <!-- View Mode -->
                <div *ngIf="!isEditing(item)">
                  <div class="detail-section">
                    <div class="section-header">
                      <h3><mat-icon>info</mat-icon> Bestellinformationen</h3>
                      <div class="header-buttons">
                        <button mat-raised-button (click)="startEdit(item)">
                          <mat-icon>edit</mat-icon> Schnell bearbeiten
                        </button>
                        <button mat-raised-button color="primary" (click)="edit(item)">
                          <mat-icon>edit_note</mat-icon> Vollständig bearbeiten
                        </button>
                      </div>
                    </div>
                    <div class="detail-grid">
                      <div class="detail-item">
                        <span class="label">Bestellnummer:</span>
                        <span class="value">{{ item.id }}</span>
                      </div>
                      <div class="detail-item">
                        <span class="label">Bestelldatum:</span>
                        <span class="value">{{ item.orderDate | date:'dd.MM.yyyy' }}</span>
                      </div>
                      <div class="detail-item">
                        <span class="label">Status:</span>
                        <span class="value"><mat-chip [color]="getStatusColor(item.status)">{{ item.status }}</mat-chip></span>
                      </div>
                      <div class="detail-item">
                        <span class="label">Gesamtbetrag:</span>
                        <span class="value">€ {{ item.totalAmount | number:'1.2-2' }}</span>
                      </div>
                    </div>
                  </div>

                  <div class="detail-section">
                    <h3><mat-icon>person</mat-icon> Kundeninformationen</h3>
                    <div class="detail-grid">
                      <div class="detail-item">
                        <span class="label">Name:</span>
                        <span class="value">{{ item.customerName }}</span>
                      </div>
                      <div class="detail-item" *ngIf="item.customerPhone">
                        <span class="label">Telefon:</span>
                        <span class="value">{{ item.customerPhone }}</span>
                      </div>
                      <div class="detail-item" *ngIf="item.customerAddress">
                        <span class="label">Adresse:</span>
                        <span class="value">{{ item.customerAddress }}</span>
                      </div>
                    </div>
                  </div>

                  <div class="detail-section" *ngIf="item.items && item.items.length > 0">
                    <h3><mat-icon>shopping_cart</mat-icon> Bestellpositionen</h3>
                    <table class="items-table">
                      <thead>
                        <tr>
                          <th>Produkt</th>
                          <th>Gewicht/Menge</th>
                          <th>Preis</th>
                          <th>Zwischensumme</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let orderItem of item.items">
                          <td>{{ orderItem.itemName || orderItem.product?.name || '-' }}</td>
                          <td>
                            <span *ngIf="orderItem.weight">{{ orderItem.weight }} kg</span>
                            <span *ngIf="!orderItem.weight && orderItem.quantity">{{ orderItem.quantity }}</span>
                          </td>
                          <td>€ {{ orderItem.unitPrice | number:'1.2-2' }}</td>
                          <td>€ {{ orderItem.subtotal | number:'1.2-2' }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <!-- Edit Mode -->
                <div *ngIf="isEditing(item) && editedOrder">
                  <div class="detail-section">
                    <div class="section-header">
                      <h3><mat-icon>edit</mat-icon> Bestellung bearbeiten</h3>
                      <div class="action-buttons">
                        <button mat-raised-button (click)="cancelEdit()">
                          <mat-icon>close</mat-icon> Abbrechen
                        </button>
                        <button mat-raised-button color="primary" (click)="saveEdit()">
                          <mat-icon>save</mat-icon> Speichern
                        </button>
                      </div>
                    </div>
                    <div class="edit-grid">
                      <mat-form-field appearance="outline">
                        <mat-label>Kundenname</mat-label>
                        <input matInput [(ngModel)]="editedOrder.customerName" required>
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Telefon</mat-label>
                        <input matInput type="tel" [(ngModel)]="editedOrder.customerPhone">
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Adresse</mat-label>
                        <input matInput [(ngModel)]="editedOrder.customerAddress">
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Status</mat-label>
                        <mat-select [(ngModel)]="editedOrder.status">
                          <mat-option *ngFor="let status of orderStatuses" [value]="status">
                            {{ status }}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"
            class="order-row"
            [class.expanded-row]="expandedElement === row"
            (click)="toggleExpand(row)"></tr>
        <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>

        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell no-data" [attr.colspan]="displayedColumns.length">
            <div class="no-data-message">
              <mat-icon>shopping_cart</mat-icon>
              <p>Keine Bestellungen gefunden</p>
            </div>
          </td>
        </tr>
      </table>
    </div>
  </div>
</div>
