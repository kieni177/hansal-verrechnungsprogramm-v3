<div class="page-content fade-in">
  <div class="page-header">
    <h1>
      <mat-icon class="header-icon">inventory</mat-icon>
      Produkte
    </h1>
    <p class="text-secondary">Verwalten Sie Ihren Produktkatalog</p>
  </div>

  <div *ngIf="isLoading" class="loading-spinner">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <div *ngIf="!isLoading" class="content-section">
    <div class="toolbar">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Produkte suchen</mat-label>
        <input matInput [(ngModel)]="searchTerm" (keyup)="applyFilter()" placeholder="Produktnamen eingeben...">
        <mat-icon matPrefix>search</mat-icon>
      </mat-form-field>
      <div class="toolbar-buttons">
        <button mat-raised-button color="warn" (click)="initializeDefaults()" matTooltip="Löscht alle Produkte und erstellt Standardprodukte">
          <mat-icon>restart_alt</mat-icon>
          Standardprodukte laden
        </button>
        <button mat-raised-button color="primary" (click)="add()" class="add-button">
          <mat-icon>add</mat-icon>
          Produkt hinzufügen
        </button>
      </div>
    </div>

    <div class="table-container">
      <table mat-table [dataSource]="dataSource" matSort multiTemplateDataRows class="mat-elevation-z2">
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Produktname</th>
          <td mat-cell *matCellDef="let item">
            <span class="product-name">{{ item.name }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="description">
          <th mat-header-cell *matHeaderCellDef>Beschreibung</th>
          <td mat-cell *matCellDef="let item">
            <span class="text-secondary">{{ item.description || '-' }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="price">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Preis</th>
          <td mat-cell *matCellDef="let item">
            <span class="price">€ {{ item.price | number:'1.2-2' }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="stockQuantity">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Lagerbestand (g)</th>
          <td mat-cell *matCellDef="let item">
            <span class="stock-badge" [class.low-stock]="item.stockQuantity < 10">
              {{ item.stockQuantity }} g
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Aktionen</th>
          <td mat-cell *matCellDef="let item" (click)="$event.stopPropagation()">
            <button mat-icon-button (click)="toggleExpand(item)" matTooltip="Details anzeigen">
              <mat-icon>{{ expandedElement === item ? 'expand_less' : 'expand_more' }}</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="delete(item.id!)" matTooltip="Löschen">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <!-- Expanded Content Column -->
        <ng-container matColumnDef="expandedDetail">
          <td mat-cell *matCellDef="let item" [attr.colspan]="displayedColumns.length">
            <div class="product-detail" [@detailExpand]="item == expandedElement ? 'expanded' : 'collapsed'">
              <div class="detail-container">
                <!-- View Mode -->
                <div *ngIf="!isEditing(item)">
                  <div class="detail-section">
                    <div class="section-header">
                      <h3><mat-icon>info</mat-icon> Produktdetails</h3>
                      <button mat-raised-button color="primary" (click)="startEdit(item)">
                        <mat-icon>edit</mat-icon> Bearbeiten
                      </button>
                    </div>
                    <div class="detail-grid">
                      <div class="detail-item">
                        <span class="label">Produktname:</span>
                        <span class="value">{{ item.name }}</span>
                      </div>
                      <div class="detail-item">
                        <span class="label">Beschreibung:</span>
                        <span class="value">{{ item.description || '-' }}</span>
                      </div>
                      <div class="detail-item">
                        <span class="label">Preis:</span>
                        <span class="value">€ {{ item.price | number:'1.2-2' }}</span>
                      </div>
                      <div class="detail-item">
                        <span class="label">Lagerbestand:</span>
                        <span class="value">{{ item.stockQuantity }} g</span>
                      </div>
                      <div class="detail-item" *ngIf="item.createdAt">
                        <span class="label">Erstellt am:</span>
                        <span class="value">{{ item.createdAt | date:'dd.MM.yyyy HH:mm' }}</span>
                      </div>
                      <div class="detail-item" *ngIf="item.updatedAt">
                        <span class="label">Zuletzt aktualisiert:</span>
                        <span class="value">{{ item.updatedAt | date:'dd.MM.yyyy HH:mm' }}</span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Edit Mode -->
                <div *ngIf="isEditing(item) && editedProduct">
                  <div class="detail-section">
                    <div class="section-header">
                      <h3><mat-icon>edit</mat-icon> Produkt bearbeiten</h3>
                      <div class="action-buttons">
                        <button mat-raised-button (click)="cancelEdit()">
                          <mat-icon>close</mat-icon> Abbrechen
                        </button>
                        <button mat-raised-button color="primary" (click)="saveEdit()">
                          <mat-icon>save</mat-icon> Speichern
                        </button>
                      </div>
                    </div>
                    <div class="edit-grid">
                      <mat-form-field appearance="outline">
                        <mat-label>Produktname</mat-label>
                        <input matInput [(ngModel)]="editedProduct.name" required>
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Beschreibung</mat-label>
                        <input matInput [(ngModel)]="editedProduct.description">
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Preis (€)</mat-label>
                        <input matInput type="number" step="0.01" [(ngModel)]="editedProduct.price" required>
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Lagerbestand (kg) - Berechnet aus Schlachtungen</mat-label>
                        <input matInput type="number" [value]="editedProduct.stockQuantity" readonly>
                        <mat-hint>Wird automatisch durch Schlachtungen aktualisiert</mat-hint>
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Bild URL</mat-label>
                        <input matInput [(ngModel)]="editedProduct.imageUrl">
                      </mat-form-field>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"
            class="product-row"
            [class.expanded-row]="expandedElement === row"
            (click)="toggleExpand(row)"></tr>
        <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>

        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell no-data" [attr.colspan]="displayedColumns.length">
            <div class="no-data-message">
              <mat-icon>inventory_2</mat-icon>
              <p>Keine Produkte gefunden</p>
            </div>
          </td>
        </tr>
      </table>
    </div>
  </div>
</div>
